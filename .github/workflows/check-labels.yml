name: Check required labels

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: ["**"]
  issue_comment:
    types: [created, edited]

# Prevent duplicate runs when swapping labels (unlabeled + labeled events fire together)
concurrency:
  group: check-labels-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  check-labels:
    name: Check PR labels
    # Only run when PR is opened/reopened or labels change (not on commits or comment edits)
    if: github.event_name == 'pull_request_target' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'labeled' || github.event.action == 'unlabeled')
    permissions:
      pull-requests: write
      checks: write
    uses: sashacmc/ci/.github/workflows/check-labels.yml@main
    secrets: inherit

  checklist-verification:
    name: Check PR checklists
    # Wait for check-labels to finish (or be skipped) before verifying
    needs: [check-labels]
    # Run on PR events and when comments are edited (always() allows running even if check-labels was skipped)
    if: always() && (github.event_name == 'pull_request_target' || (github.event_name == 'issue_comment' && github.event.issue.pull_request))
    permissions:
      pull-requests: write
      statuses: write
    uses: sashacmc/ci/.github/workflows/checklist-verification.yml@main
    secrets: inherit
